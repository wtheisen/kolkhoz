<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=yes">
  <meta name="description" content="Колхоз (Kolkhoz) - A card game about Soviet collective farms">
  <meta name="theme-color" content="#c9a961">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Kolkhoz">
  <title>Колхоз (Kolkhoz)</title>
  <link rel="icon" type="image/svg+xml" href="assets/medal.svg">
  <link rel="apple-touch-icon" href="assets/medal_icon.png">
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="assets/style.css">
</head>
<body>
  <div class="page-wrapper">
    <header class="topbar">
      <div class="top-section">Колхоз (Kolkhoz):</div>
      <div class="jobs">
        <button class="button" id="start-game">Start Game</button>
        <button class="button" id="continue-game" style="display: none; margin-left: 8px;">Continue Game</button>
      </div>
    </header>

    <main class="main">
      <section id="kolkhoz-rules" class="rules-section">
        <iframe src="https://docs.google.com/document/d/e/2PACX-1vT0wmZXS3b4hT7NXVtfzjqVbgCs-RUcKtCxoeAE9d71jKXUEy6iYJkw1FMjfxPrtzmwVQ1YWUY4C0cN/pub?embedded=true"
                class="rules-iframe"
                frameborder="0"></iframe>
      </section>
    </main>
  </div>

  <!-- Game Variant Selection Modal -->
  <div id="variant-modal" class="modal" style="display: none;">
    <div class="modal-backdrop"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h2>Game Variants</h2>
        <button class="modal-close" id="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <form id="variant-form">
          <div class="variant-option">
            <label class="variant-label">Deck Type</label>
            <div class="radio-group">
              <label class="radio-label">
                <input type="radio" id="deck-52" name="deckType" value="52">
                <span>52-Card Deck (Standard)</span>
              </label>
              <label class="radio-label">
                <input type="radio" id="deck-36" name="deckType" value="36" checked>
                <span>36-Card Deck</span>
              </label>
            </div>
            <p class="variant-description">
              Select the deck type. The 52-card deck uses cards 6-King for workers (32 cards) with Ace-5 as job rewards. The 36-card deck uses cards 6-King for workers (32 cards) with Aces only as job pile indicators (no rewards).
            </p>
          </div>
          
          <div class="variant-option">
            <label class="variant-checkbox">
              <input type="checkbox" id="northern-style" name="northernStyle">
              <span class="checkbox-label">[Вариант] Игра по-северному</span>
            </label>
            <p class="variant-description">
              There is no reward for finishing a job and no need to remember who has been Бригадир. All players are vulnerable during requisition, not just brigade leaders.
            </p>
          </div>
          
          <div class="variant-option">
            <label class="variant-checkbox">
              <input type="checkbox" id="nomenclature" name="nomenclature" checked>
              <span class="checkbox-label">[Вариант] Номенклатура живёт по своим законам</span>
            </label>
            <p class="variant-description">
              Face cards (Jack, Queen, King) of the trump suit have special effects:
              <ul>
                <li><strong>Jack (Пьяница - Drunkard):</strong> Contributes 0 work hours. If the job fails, the Drunkard is exiled instead of your cards.</li>
                <li><strong>Queen (Информатор - Informant):</strong> If the job fails, all players must reveal their Personal Plots, not just the Brigade Leaders.</li>
                <li><strong>King (Партийный чиновник - Party Official):</strong> If the job is requisitioned, two cards are exiled instead of one.</li>
              </ul>
            </p>
          </div>
          
          <div class="variant-option">
            <label class="variant-checkbox">
              <input type="checkbox" id="mice-variant" name="miceVariant">
              <span class="checkbox-label">[Вариант] Разговоры вели даже с мышами</span>
            </label>
            <p class="variant-description">
              For each работа that did not reach the work-hour threshold, all players reveal the highest hidden card in their подвал that matches the failed работа. The highest card is then отправить на Север.
            </p>
          </div>
          
          <div class="variant-option" id="orden-nachalniku-option" style="display: none;">
            <label class="variant-checkbox">
              <input type="checkbox" id="orden-nachalniku" name="ordenNachalniku" checked>
              <span class="checkbox-label">[Вариант] Орден — начальнику, работа — нам (36-Card Deck Only)</span>
            </label>
            <p class="variant-description">
              When a работа is closed, the Бригадир that closes it immediately adds the workers assigned to the работа in a singular stack to their подвал with the lowest card face-up on top. Cards that are отправить на Север are shuffled back into the deck at the start of the next year.
            </p>
          </div>
          
          <div class="variant-option">
            <label class="variant-checkbox">
              <input type="checkbox" id="medals-count" name="medalsCount">
              <span class="checkbox-label">Medals Count Toward Score</span>
            </label>
            <p class="variant-description">
              When enabled, players earn medals for winning tricks, and these medals count toward the final score. When disabled, medals are not awarded and do not affect scoring.
            </p>
          </div>
          <div class="variant-option">
            <label class="variant-checkbox">
              <input type="checkbox" id="accumulate-jobs" name="accumulateUnclaimedJobs" checked>
              <span class="checkbox-label">Accumulate Unclaimed Job Rewards (52-Card Deck Only)</span>
            </label>
            <p class="variant-description">
              When enabled, if a job is not completed (doesn't reach the work hour threshold), its reward value accumulates to the next year. The new year's job reward will be added to any unclaimed rewards from previous years. This option is only available for the 52-card deck, as the 36-card deck has no job rewards.
            </p>
          </div>
          <div class="variant-option">
            <label class="variant-checkbox">
              <input type="checkbox" id="allow-swap" name="allowSwap">
              <span class="checkbox-label">Allow Card Swap at Year Start</span>
            </label>
            <p class="variant-description">
              When enabled, at the start of each year, players can swap one of their face-down Personal Plot cards with one card from their hand. This happens before the planning phase.
            </p>
          </div>
          <div class="modal-actions">
            <button type="button" class="button button-secondary" id="modal-cancel">Cancel</button>
            <button type="submit" class="button button-primary" id="modal-start">Start Game</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script type="module" src="js/lobby.js"></script>
  <script>
    // Unregister any existing service workers first (for debugging)
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations().then(function(registrations) {
        for(let registration of registrations) {
          registration.unregister();
          console.log('Unregistered old service worker');
        }
      });
    }
    
    // Register service worker for PWA
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then((registration) => {
            console.log('SW registered: ', registration);
          })
          .catch((registrationError) => {
            console.log('SW registration failed: ', registrationError);
          });
      });
    }
    
    // Global error handler to catch any unhandled errors
    window.addEventListener('error', (event) => {
      console.error('Global error:', event.error, event.filename, event.lineno);
      // Show error on page if it's a critical error
      if (event.error && event.error.message) {
        document.body.innerHTML = `
          <div style="color: white; padding: 20px; font-family: sans-serif; background: #000;">
            <h1>JavaScript Error</h1>
            <p>${event.error.message}</p>
            <p>Check the browser console (F12) for more details.</p>
            <button onclick="location.reload()" style="padding: 10px 20px; margin-top: 10px; cursor: pointer;">
              Reload Page
            </button>
          </div>
        `;
      }
    });
    
    window.addEventListener('unhandledrejection', (event) => {
      console.error('Unhandled promise rejection:', event.reason);
    });
  </script>
</body>
</html>
